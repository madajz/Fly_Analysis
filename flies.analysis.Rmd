---
title: "Flies: Everything V3"
output:
  html_document:
    toc: yes
    toc_float: no
---


```{r, include=FALSE}

options(repos = BiocManager::repositories())
getOption("repos")
library(ordinal)

library(knitr)
library(glmmTMB)
library(reshape2)
library(ggplot2)
library(viridis)
library(emmeans)
library(car)
library(shiny)
library(plotly)
library(patchwork)
library(powerMediation)
library(pwr)
library(dplyr)
library(data.table)
library(pwr)
library(gghalves)
library(sgpv)
library(diptest)
library(mclust)
library(sigclust)
library(LaplacesDemon)
library(viridis)
library(mousetrap)
library(lme4)
library(tidyr)
library(readxl)
library(robustlmm)
library(zoo)
library(pheatmap)
options(scipen=999)


opts_chunk$set(echo=FALSE, fig.align='center', warning=FALSE, message=FALSE, dev=c('png','cairo_pdf'), cache=FALSE,error=FALSE,fig.width=8,fig.height=10)

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}

setwd("/data/home/zachary.madaj/flies/")
library(qdapRegex)


all.files = list.files(pattern = ".xlsx$", recursive = TRUE)

```

```{r}
# Code chunk to store functions for use later on

format_heat = function(df.ht){
  df.ht$Comparison = gsub(" - Control","",df.ht$Comparison)
  df.ht$Amount = substrRight(df.ht$Comparison,1)
  df.ht$Compound = gsub(" ","" ,substr(df.ht$Comparison  ,1,nchar(df.ht$Comparison  )-1))
  
  heat.df = reshape(subset(df.ht, select = - c(Comparison)), idvar = "Compound", timevar = "Amount", direction = "wide")
  
  rownames(heat.df) = heat.df$Compound
  heat.df = subset(heat.df,select= - c(Compound))
  
  
  heat.df = heat.df[,order(as.numeric(gsub(" ","",substr(colnames(heat.df),1,2))), factor(substrRight(colnames(heat.df),1),levels=c("L","M","H")))]
  
  return(heat.df)
  
}

 

p_val_heatmap = function(heat.df){
  

  
  if(ncol(heat.df)/3>=2) {
    annotate = data.frame(Out = substr(colnames(heat.df),1,nchar(colnames(heat.df))-1), Amount = factor(substrRight(colnames(heat.df),1),levels=c("L","M","H")))
    rownames(annotate) = colnames(heat.df)
    Var1        = viridis::viridis(ncol(heat.df)/3)
    names(Var1) = c(unique(annotate$Out))
    
    
    Var2        =  rev(viridis::mako(3))
    names(Var2) = c(unique(annotate$Amount))
    
    anno_colors = list(Out = Var1,Amount=Var2)

  } else {
    
     annotate = data.frame(Amount = factor(substrRight(colnames(heat.df),1),levels=c("L","M","H")))
    rownames(annotate) = colnames(heat.df)

    Var1        =  rev(viridis::mako(3))
    names(Var1) = c(unique(annotate$Amount))
    
    anno_colors = list(Amount=Var1)

    
  }
  
  breaks = c(seq(0,0.1,0.01),0.25,0.5,0.75,seq(0.9,1,0.01))

  mycols = c(colorRampPalette(c("darkred","red","white"))(length(c(seq(0,0.1,0.01),0.25))),"white",
           colorRampPalette(c("white","grey","black"))(length(c(0.75,seq(0.9,1,0.01)))))

  

  print(pheatmap(heat.df, cluster_rows = F,cluster_cols = F, annotation_col = annotate, annotation_colors =anno_colors, color=mycols,breaks=breaks))
  
}


eff_heatmap = function(heat.df){
  breaks = seq(-2,2,0.25)
  mycols = colorRampPalette(c("blue","white","red"))(16)

  
  if(ncol(heat.df)/3>=2) {
    annotate = data.frame(Out = substr(colnames(heat.df),1,nchar(colnames(heat.df))-1), Amount = factor(substrRight(colnames(heat.df),1),levels=c("L","M","H")))
    rownames(annotate) = colnames(heat.df)
    Var1        = viridis::viridis(ncol(heat.df)/3)
    names(Var1) = c(unique(annotate$Out))
    
    
    Var2        =  rev(viridis::mako(3))
    names(Var2) = c(unique(annotate$Amount))
    
    anno_colors = list(Out = Var1,Amount=Var2)

  } else {
    
     annotate = data.frame(Amount = factor(substrRight(colnames(heat.df),1),levels=c("L","M","H")))
    rownames(annotate) = colnames(heat.df)

    Var1        =  rev(viridis::mako(3))
    names(Var1) = c(unique(annotate$Amount))
    
    anno_colors = list(Amount=Var1)

    
  }
  
  heat.df[which(heat.df > 2,arr.ind=T)] = 2
  heat.df[which(heat.df < -2,arr.ind=T)] = -2
  
  print(pheatmap(heat.df, cluster_rows = F,cluster_cols = F, annotation_col = annotate, annotation_colors =anno_colors, color=mycols,breaks=breaks))
  
}



```

# Data file {.tabset}

For all analyses second generation p-values were used to control the false discovery rate. This method was chosen as it is not reliant on the number of tests run nor is it overly punitive when there are non-independent tests. We have many tests that are at least somewhat dependent because they use the same toxin but at different concentrations. Further, by using second gen p-values we can continually add more and more toxins to the screening without having to incur further penalties (p-vals don't change based on new data). The null interval is based on recommendations from the original methods paper and it is +/-10% for all models. Results are presented in a table of second generation p-values (SGPV) and as heatmaps. SGPV = 0 is considered significant, SGPV =1 is evidence of equivalence, and SGPV = 0.5 is exactly inconclusive. A SGPV = 0.04 is not significant, but it does indicate that there is more evidence of a difference than no difference.  These results may just be under powered and could be worth investigating further as a "potential hit". In the effects heatmaps, all results are either log(fold-change) or log(odds), regardless, red indicates the toxin was higher relative to control and blue the toxin was lower. 

## TG {.tabset}


```{r}
##This code chunk is for data processing only, but should include all necessary data processing

### Gathering all TG data, combining them into one data frame for easier processing and final plots.
library(DescTools)
df=NULL
all.files = list.files(pattern = ".xlsx$", recursive = TRUE)

for(i in all.files[grepl( "TG", all.files, fixed = TRUE)]){
  df1 =  as.data.frame(read_excel(i,sheet = 1,skip=2))
  
  df1[,1:2] = LOCF(df1[,1:2])
  colnames(df1)[1:3] = c("Toxin","Conc","Rep")
  ix = which(tolower(df1$Toxin) == "female" | tolower(df1$Toxin) == "females",arr.ind=T)
  
  if(length(ix)>0){
    df1 = df[1:ix-1,]
  }
  
  df1 = df1[df1$Rep != "Average",]
  
  df1$Set = case_when(grepl( "Blue", i, fixed = TRUE)~"Blue",
                      grepl( "Orange", i, fixed = TRUE)~"Orange",
                      grepl( "Pink", i, fixed = TRUE)~"Pink",
                      grepl( "blue", i, fixed = TRUE)~"Blue",
                      grepl( "orange", i, fixed = TRUE)~"Orange",
                      grepl( "pink", i, fixed = TRUE)~"Pink",
                      TRUE~"Check"
  )
  
  df1$Compound = sub("/.*", "", i)
  
  
  df = rbind(df,df1)
  
}

df=subset(df,select=c('Compound','Toxin','Conc','Rep','weight of 1 fly (g)','OD/weight as % of control', 'OD/#flies as % of control' ,   'Set'))

df.m = reshape2::melt(df,id.vars=c('Toxin','Conc','Rep','Set','Compound'))

df.m$Conc[is.na(df.m$Conc)] = ""
df.m$Conc[tolower(df.m$Conc) == "high"] = "H"
df.m$Conc[tolower(df.m$Conc) == "mid"] = "M"
df.m$Conc[tolower(df.m$Conc) == "low"] = "L"

df.m$Conc[df.m$Toxin=="Control"]=""
df.m$Group = paste0(df.m$Toxin,df.m$Conc)


df.m$value = as.numeric(df.m$value)

df.m$Group = gsub(",","",df.m$Group)
df.m$Group = gsub("\\(","",df.m$Group)
df.m$Group = gsub("\\)","",df.m$Group)
df.m$Group = gsub("-","",df.m$Group)

df.m$Group = factor(df.m$Group,levels=unique(df.m$Group))

```

### Exploratory Plots

```{r , fig.width= length(unique(df.m$Group))/6 ,fig.height = length(unique(df.m$variable))*3}


##Code chunk for plots
knitr::kable(table(df$Compound))

## Simple dot plot of all the data
ggplot(na.omit(df.m),aes(x=Group,y=value,color=Group,shape=Set)) +theme_classic(14)+theme(legend.position = "none",axis.text.x = element_text(angle=90,hjust=1))+geom_jitter(height = 0,width=.15)+   scale_color_viridis(discrete=T)+facet_wrap(~variable,scales="free_y",ncol=1)+xlab("")+theme(strip.background = element_blank())

## Simple bar plot of all the data
agg.d = aggregate(value~Group+variable,df.m,mean)
ggplot(na.omit(agg.d),aes(x=Group,y=value,fill=Group)) +theme_classic(14)+theme(legend.position = "none",axis.text.x = element_text(angle=90,hjust=1))+geom_bar(stat="identity")+   scale_fill_viridis(discrete=T)+facet_wrap(~variable,scales="free_y",ncol=1)+xlab("")+theme(strip.background = element_blank())
```


### Analysis

log 2 transformed robust linear mixed-effects model with a random effect for set (blue, pink, orange). Methods Rationale: the random effects of this model account for the relatedness of replicates within a set which is important for both reducing bias and getting a better estimate of group variance (ie improves power). Ratios such as OD/#flies as % of control and OD/weight as % of control are often right tail heavy; weight can also be right-tailed heavy or roughly Gaussian. A log transformation is a common transformation for right tailed heavy data to improve normality of residuals. The robust part of this regression is to reduce the impact of highly influential individuals (re: outliers) and unequal variances among the groups. 


```{r}

#This code chunk is for analyzing the data, it produces 2 data frames, one for second gen p-values and one for effect sizes (log2FC)

res.all=NULL
eff.all=NULL

for(i in unique(df.m$Compound)){
  fit = rlmer(log(value)~Group+(1|Set),data=df.m[df.m$variable == 'weight of 1 fly (g)'&df.m$Compound==i,])
  
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts
  
  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta
  
  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P")),caption="Differences in the number of pupae")
  
  res.m = res[,c(1,7)]
  colnames(res.m)[2] = "Weight of 1 fly (g)"
  
  eff.m = res[,c(1,2)]
  colnames(eff.m)[2] = "Weight of 1 fly (g)"
  
  fit = rlmer(log2(value)~Group+(1|Set),data=df.m[df.m$variable == 'OD/weight as % of control'&df.m$Compound==i,])
  
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts
  
  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log2(.9),
    null.hi=log2(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta
  
  # res$estimate = 2^(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P")),caption="Differences in the number of pupae")
  
  
  res.t=res[,c(1,7)]
  colnames(res.t)[2] = "OD/weight as % of control"
  
  eff.t = res[,c(1,2)]
  colnames(eff.t)[2] = "OD/weight as % of control"
  
  fit = rlmer(log2(value)~Group+(1|Set),data=df.m[df.m$variable == 'OD/#flies as % of control' &df.m$Compound==i,])
  
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts
  
  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log2(.9),
    null.hi=log2(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta
  
  # res$estimate = 2^(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P")),caption="Differences in the number of pupae")
  
  res.c=res[,c(1,7)]
  colnames(res.c)[2] = "OD/#flies as % of control"
  
  eff.c = res[,c(1,2)]
  colnames(eff.c)[2] = "OD/#flies as % of control"
  
  res.all=rbind(res.all,merge(merge(res.m,res.t),res.c))
  
  eff.all=rbind(eff.all,merge(merge(eff.m,eff.t),eff.c))
  
}

eff.all[2:ncol(eff.all)] = log2(eff.all[2:ncol(eff.all)])

knitr::kable(res.all,digits=3,caption = "Second Generation P-values")

```


### Results Plots {.tabset}

#### Second Generation P-val Heatmap

```{r, fig.width=length(unique(df.m$variable)),fig.height=length(unique(df.m$Group))/9}

p_val_heatmap(format_heat(res.all))
```

#### log2(fold-change) Heatmap


```{r, fig.width=length(unique(df.m$variable))*2,fig.height=length(unique(df.m$Group))/9}

eff_heatmap(format_heat(eff.all))

```

## Longevity {.tabset}

```{r, fig.height=5,fig.width=12}

df=NULL
all.files = list.files(pattern = ".xlsx$", recursive = TRUE)

for(i in all.files[grepl( "long", all.files, fixed = TRUE)|grepl( "Long", all.files, fixed = TRUE)]){
  # 
  if(i ==  "Heavy metals and DBCM 2021/Longevity Blue.xlsx" ){

      df.t = as.data.frame(read_excel(i,sheet = 1,skip=0))
      colnames(df.t)[substr(colnames(df.t),1,3)=="..."]=NA
      colnames(df.t) = na.locf(colnames(df.t), na.rm = FALSE)
      df.t = df.t[,c(2,which(df.t[1,] != "Total"& df.t[1,] != "average"))]
      colnames(df.t)[3]="Age"
      R = df.t[1,3:ncol(df.t)]
      R=gsub("\\#","",R)
      df.t=df.t[-1,3:ncol(df.t)]
      
      colnames(df.t)[2:ncol(df.t)] = gsub("\\..*","",colnames(df.t)[2:ncol(df.t)])
      
      for(s in 2:ncol(df.t)){
        colnames(df.t)[s] = paste0(colnames(df.t)[s],".",R[s])
      }
      
      df.t = reshape2::melt(df.t,id.vars=c("Age"))
      df.t=df.t[df.t$Age!="Age (days)",]

      colnames(df.t)[c(1,2)]=c("variable","Group")

      df.t$R = gsub(".*\\.","",df.t$Group)

      df.t$Group = gsub("\\..*","",df.t$Group)

      df.t$Set = "Blue"
      df.t$Compound = "Heavy metals and DBCM 2021"
      df.t$variable = as.numeric(as.character(df.t$variable))
      df.t$Conc =    gsub(".* ","",df.t$Group)



  } else {

    df.t = as.data.frame(read_excel(i,sheet = 1,skip=4))
    
    colnames(df.t)[1:3] = c("Group","Conc","R")
    df.t$Set = case_when(grepl( "Blue", i, fixed = TRUE)~"Blue",
                         grepl( "Orange", i, fixed = TRUE)~"Orange",
                         grepl( "Pink", i, fixed = TRUE)~"Pink",
                         grepl( "blue", i, fixed = TRUE)~"Blue",
                         grepl( "orange", i, fixed = TRUE)~"Orange",
                         grepl( "pink", i, fixed = TRUE)~"Pink",
                         TRUE~"Check"
                         
                         
    )
    
    ix = which(tolower(df.t$Group) == "female" | tolower(df.t$Group) == "females",arr.ind=T)
    
    if(length(ix)>0){
      df.t = df.t[1:ix-1,]
    }
  
    
    
    df.t$Group = na.locf(df.t$Group, na.rm = FALSE)
  
    df.t$Conc = na.locf(df.t$Conc, na.rm = FALSE)
    df.t$Conc[is.na(df.t$Conc)] = ""
    
    df.t$Group = paste0(df.t$Group,df.t$Conc)
  
    df.t$Compound = sub("/.*", "", i)
    
    df.t = reshape2::melt(df.t,id.vars=c( "Set","Compound","Group","Conc","R"))
    df.t$variable = as.character(df.t$variable)
  }
  
  df=rbind(df,df.t)

}

df.m = df[!is.na(df$value),]

df.m$Group = gsub("high", "H",df.m$Group)
df.m$Group = gsub("High", "H",df.m$Group)
df.m$Group = gsub("Med", "M",df.m$Group)
df.m$Group = gsub("med", "M",df.m$Group)
df.m$Group = gsub("mid", "M",df.m$Group)
df.m$Group = gsub("Mid", "M",df.m$Group)
df.m$Group = gsub("Low", "L",df.m$Group)
df.m$Group = gsub("low", "L",df.m$Group)

df.m = df.m[df.m$Group != "Date" & df.m$Group != "Age(days)",]

df.m$Group[substr(df.m$Group,1,7)=="Control"] ="Control"

df.m$Conc[substr(df.m$Group,1,7) == "Control"]   = ""


df.m$value = as.numeric(df.m$value)

df.m$variable = as.numeric(df.m$variable)

df.m$Group = gsub(",","",df.m$Group)
df.m$Group = gsub("\\(","",df.m$Group)
df.m$Group = gsub("\\)","",df.m$Group)
df.m$Group = gsub("-","",df.m$Group)


df.m$Toxin = substr(as.character(df.m$Group)  ,1,nchar(as.character(df.m$Group) )-1)
df.m$Toxin[df.m$Toxin == "Contro"] = "Control"
df.m$Toxin = factor(df.m$Toxin,levels=unique(df.m$Toxin))

df.m$Group = factor(df.m$Group,levels=unique(df.m$Group))


```

### Plots {.tabset}
#### Smoothed Average


```{r, fig.height=5,fig.width=12}
knitr::kable(table(df$Compound))

for(i in unique(df.m$Compound)){

  print(ggplot(na.omit(df.m[df.m$R == "% survival"&df.m$variable>14&df.m$variable<60 &df.m$Compound == i,]),aes(x=variable,y=value,color=Group)) +theme_classic(14)+theme(axis.text.x = element_text(angle=90,hjust=1))+ scale_color_viridis(discrete=T)+geom_smooth(se=F,aes(group=Group))+ylab("% Total Survival")+ggtitle(i))

}

```

#### Raw data

```{r, fig.height=5,fig.width=12}

for(i in unique(df.m$Compound)){

  print(ggplot(na.omit(df.m[df.m$R == "% survival"&df.m$variable>14&df.m$variable<60 &df.m$Compound == i,]),aes(x=variable,y=value,color=Group,shape=Set)) +theme_classic(14)+theme(axis.text.x = element_text(angle=90,hjust=1))+geom_jitter(height = 0,width=.15)+   scale_color_viridis(discrete=T)+ylab("% Total Survival")+ggtitle(i))

}


# ggplot(na.omit(df.m[df.m$R == "% survival"&df.m$variable>14&df.m$variable<60,]),aes(x=Group,y=value,color=Group,shape=Set)) +theme_classic(14)+theme(axis.text.x = element_text(angle=90,hjust=1),legend.position = "none")+geom_point() +  scale_color_viridis(discrete=T)+ylab("% Total Survival")+facet_wrap(~Compound)+ facet_wrap(~variable,ncol=1)

```

#### Time until 50% Dead

A complication of this method is that there are some time points where, for example one group was measured at day 38 and another at day 39.  This creates an immortal time bias scenario where, if controls were measured at 38 and a toxin at 39, there's a day where the toxin group cannot die; a difference could be driven entirely by this bias. To get around this we will pool consecutive days and then use a rank-based method (so day 38 and 39 would have the same rank). It's most important that this is done just within a toxin group (eg heavy metals), as data are analyzed by the overall toxin group/class. 

```{r, fig.height=5.5,fig.width=17}



reps = df.m[df.m$R != "% survival" & df.m$R !="Total",]

# table(reps$variable,reps$Compound)

for(j in unique(reps$Compound)){
  
  ix = which(abs(diff(unique(reps$variable[reps$Compound == j])))<=1)
  for(z in ix){
    replace = unique(reps$variable[reps$Compound == j])[z]
    reps$variable[which(reps$variable == unique(reps$variable[reps$Compound == j])[z] |
                         reps$variable == unique(reps$variable[reps$Compound == j])[z+1])] = replace
  }
}

First.fly = df.m[df.m$R != "% survival" & df.m$R !="Total" & df.m$variable==14,]
colnames(First.fly)[7] = "Start"

reps = left_join(reps,First.fly)
reps$Start=zoo::na.locf(reps$Start)

reps$Percent = reps$value/reps$Start

reps$ID = paste0(reps$Set,reps$Compound,reps$Group,reps$R)

reps = reps[order(reps$variable,decreasing = F),]

reps.50 = reps[reps$Percent<= 0.5,]

reps.50 = reps.50[!duplicated(reps.50$ID),]
reps.50$variable = as.numeric(reps.50$variable)

agg.d = aggregate(variable~Group,reps.50,mean)

ggplot(reps.50,aes(x=Group,y=variable,color=Group,shape=Set)) + geom_point()+theme_classic(14)+scale_fill_viridis_d()+theme_classic(14)+theme(axis.text.x = element_text(angle=90,hjust=1),legend.position = "none")+  scale_color_viridis(discrete=T)+ylab("Time until 50% Death")

ggplot(agg.d,aes(x=Group,y=variable,fill=Group)) + geom_bar(stat="identity")+theme_classic(14)+scale_fill_viridis_d()+theme_classic(14)+theme(axis.text.x = element_text(angle=90,hjust=1),legend.position = "none")+  scale_color_viridis(discrete=T)+ylab("Time until 50% Death")


```



#### Time until 90% Dead

```{r, fig.height=5.5,fig.width=17}

reps = df.m[df.m$R != "% survival" & df.m$R !="Total",]

for(j in unique(reps$Compound)){

  ix = which(abs(diff(unique(reps$variable[reps$Compound == j])))<=1)
  for(z in ix){
    replace = unique(reps$variable[reps$Compound == j])[z]
    reps$variable[which(reps$variable == unique(reps$variable[reps$Compound == j])[z] |
                         reps$variable == unique(reps$variable[reps$Compound == j])[z+1])] = replace
  }
}


First.fly = df.m[df.m$R != "% survival" & df.m$R !="Total" & df.m$variable==14,]
colnames(First.fly)[7] = "Start"

reps = left_join(reps,First.fly)
reps$Start=zoo::na.locf(reps$Start)

reps$Percent = reps$value/reps$Start



reps$ID = paste0(reps$Set,reps$Compound,reps$Group,reps$R)

reps = reps[order(reps$variable,decreasing = F),]

reps.90 = reps[reps$Percent <= 0.1,]

reps.90 = reps.90[!duplicated(reps.90$ID),]
reps.90$variable = as.numeric(reps.90$variable)

agg.d = aggregate(variable~Group,reps.90,mean)

ggplot(reps.90,aes(x=Group,y=variable,color=Group,shape=Set)) + geom_point()+theme_classic(14)+scale_fill_viridis_d()+theme_classic(14)+theme(axis.text.x = element_text(angle=90,hjust=1),legend.position = "none")+  scale_color_viridis(discrete=T)+ylab("Time until >90% Death")

ggplot(agg.d,aes(x=Group,y=variable,fill=Group)) + geom_bar(stat="identity")+theme_classic(14)+scale_fill_viridis_d()+theme_classic(14)+theme(axis.text.x = element_text(angle=90,hjust=1),legend.position = "none")+  scale_color_viridis(discrete=T)+ylab("Time until >90% Death")


```

#### AUCs

```{r, fig.height=5.5,fig.width=17}

library(DescTools)
  
reps$ID.2 = paste0(reps$Group,reps$Set,reps$R,reps$Compound)

reps.auc = NULL
for(i in unique(reps$ID.2)){
  tmp = subset(reps[reps$ID.2 == i,][1,],select=c(Set,Compound,Group,Conc,R,Toxin,ID.2))
  tmp$AUC = AUC(reps[reps$ID.2 == i,]$variable,reps[reps$ID.2 == i,]$value)
  reps.auc = rbind(reps.auc,tmp)
  
}

agg.d = aggregate(AUC~Group,reps.auc,mean)

ggplot(agg.d,aes(x=Group,y=AUC,fill=Group)) + geom_bar(stat="identity")+theme_classic(14)+scale_fill_viridis_d()+theme_classic(14)+theme(axis.text.x = element_text(angle=90,hjust=1),legend.position = "none")+  scale_color_viridis(discrete=T)+ylab("AUC")

```



### Analysis {.tabset}

#### Results

There are many ways I could see these data being analyzed. Some obvious ones to me are time until 50% total survival and time until 90% death (100% could also make sense, but by going to 90% ie 14/15, we eliminate the cases where one outlying replicate happens to live for much longer by chance, 90% is a hedge). Area under the curves is another interesting one where it would effectively measure the density of deaths over time; a small AUC means flies died quickly, vs a higher AUC means they lived longer overall. One could try to do rate of death, but that will be a 3 or 4 parametric model which we don't have enough data to reliably fit). I've run 50% death, 90% death, and AUC to start but am happy to run others or modify these. The regression method is a cumulative-logit ordinal regression, a random effect was included to account for set (orange, pink, blue). Ordinal regression is similar to a Wilcoxon test, but with a few improvements. 


```{r}

res.all=NULL
eff.all=NULL

for(i in unique(df.m$Compound)){
  if(length(unique(df.m[df.m$Compound==i,]$Set))>1){    
    fit = clmm(as.factor(variable)~Group+(1|Set),data=reps.50[reps.50$Compound == i,])
  } else {
    fit = clm(as.factor(variable)~Group,data=reps.50[reps.50$Compound == i,])
  }
  
  
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts
  
  if(any(is.na(res))){
    res$SGPV = 0.5
  } else {
  
    res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
    )$p.delta
  }
  
  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P")),caption="Differences in the number of pupae")
  
  res.50 = res[,c(1,7)]
  colnames(res.50)[2] = "Time 50% Death"

  eff.50 = res[,c(1,2)]
  colnames(eff.50)[2] = "Time 50% Death"
  
  
  if(length(unique(df.m[df.m$Compound==i,]$Set))>1){    
    fit = clmm(as.factor(variable)~Group+(1|Set),data=reps.90[reps.90$Compound == i,])
  } else {
    fit = clm(as.factor(variable)~Group,data=reps.90[reps.90$Compound == i,])
  }
  
  
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts
  
 if(any(is.na(res))){
    res$SGPV = 0.5
  } else {
  
    res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
    )$p.delta
  }
 
  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P")),caption="Differences in the number of pupae")
  
  res.90 = res[,c(1,7)]
  colnames(res.90)[2] = "Time 90% Death"

  eff.90 = res[,c(1,2)]
  colnames(eff.90)[2] = "Time 90% Death"
  
  
    
  if(length(unique(df.m[df.m$Compound==i,]$Set))>1){    
    fit = clmm(as.factor(AUC)~Group+(1|Set),data=reps.auc[reps.auc$Compound == i,])
  } else {
    fit = clm(as.factor(AUC)~Group,data=reps.auc[reps.auc$Compound == i,])
  }
  
  
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts
  
 if(any(is.na(res))){
    res$SGPV = 0.5
  } else {
  
    res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
    )$p.delta
  }
 
  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P")),caption="Differences in the number of pupae")
  
  res.auc = res[,c(1,7)]
  colnames(res.auc)[2] = "AUC"

  eff.auc = res[,c(1,2)]
  colnames(eff.auc)[2] = "AUC"

  
  res.all=rbind(res.all,merge(merge(res.50,res.90,by="Comparison"),res.auc,by="Comparison"))
  
  eff.all=rbind(eff.all,merge(merge(eff.50,eff.90,by="Comparison"),eff.auc,by="Comparison"))

}

knitr::kable(res.all,digits=3,caption = "Second Generation P-values")

# res.all[res.all$Comparison == "NA - Control",]
  
```

### Results plots {.tabset}

#### Second Generation P-val Heatmap

```{r, fig.width=5,fig.height=12}

p_val_heatmap(format_heat(res.all))

```

#### log2(fold-change) Heatmap


```{r, fig.width=5,fig.height=12}

eff_heatmap(format_heat(eff.all))

```



## Fecundity {.tabset}


```{r}

df=NULL
all.files = list.files(pattern = ".xlsx$", recursive = TRUE)

for(i in all.files[grepl( "Fecundity", all.files, fixed = TRUE)|grepl( "fecundity", all.files, fixed = TRUE)]){
  
  ## This exception had to be hard-coded; something is slightly different with these two files
  if(i %in% c("Heavy metals and DBCM 2021/Fecundity Pink.xlsx","Heavy metals and DBCM 2021/Fecundity Blue.xlsx")){
    df.t = as.data.frame(read_excel(i,sheet = 1,skip=2)[,1:5])
  } else {
    df.t = as.data.frame(read_excel(i,sheet = 1,skip=3)[,1:5])
  }
  
  colnames(df.t) = c("Group","Conc","R1","R2","R3")
  df.t$Set = case_when(grepl( "Blue", i, fixed = TRUE)~"Blue",
                       grepl( "Orange", i, fixed = TRUE)~"Orange",
                       grepl( "Pink", i, fixed = TRUE)~"Pink",
                       grepl( "blue", i, fixed = TRUE)~"Blue",
                       grepl( "orange", i, fixed = TRUE)~"Orange",
                       grepl( "pink", i, fixed = TRUE)~"Pink",
                       TRUE~"Check"
  )
  
  df.t$Group[df.t$Group == " "] = NA
  df.t$Group = na.locf(df.t$Group, na.rm = FALSE)
  
  df.t$Conc[is.na(df.t$Conc)] = ""
  
  
  
  df.t$Compound = sub("/.*", "", i)
  
  df=rbind(df,df.t)

}

  df$Conc = factor(tolower(df$Conc),levels=c("","low","med","high"),labels=c("","L","M","H"))
  df$Group = paste0(df$Group,df$Conc)
  
  
  df.m = reshape2::melt(df,id.vars=c("Group","Conc","Set","Compound"))
  
  
  df.m$Group = gsub(",","",df.m$Group)
  df.m$Group = gsub("\\(","",df.m$Group)
  df.m$Group = gsub("\\)","",df.m$Group)
  df.m$Group = gsub("-","",df.m$Group)
  df.m$Group = gsub("_","",df.m$Group)

  df.m$Group = factor(df.m$Group,levels=unique(df.m$Group))

  df.m = na.omit(df.m)
  
```

### Exploratory Plots

```{r ,fig.width= length(unique(df.m$Group))/7 ,fig.height = length(unique(df.m$variable))*2}
##Code chunk for plots
knitr::kable(table(df$Compound))

  ggplot(df.m,aes(x=Group,y=value,color=Group,shape=Set))+theme_classic(14)+theme(legend.position = "none")+geom_jitter(height = 0,width=.15)+   scale_color_viridis(discrete=T)+ylab("Pupae Number")+theme(axis.text.x = element_text(angle=90,hjust=1))

agg = aggregate(value~Group,df.m,"mean")
ggplot(agg,aes(x=Group,y=value,fill=Group))+theme_classic(14)+theme(legend.position = "none")+geom_bar(stat="identity")+   scale_fill_viridis(discrete=T)+ylab("Mean Pupae Number")+theme(axis.text.x = element_text(angle=90,hjust=1))
```


### Analysis 


Negative binomial mixed-effects mode with a random intercept for set (blue, pink, orange). Tje random effect is included to account for relatedness within each set.  The choice for negative binomial regression is because these are count data.  


```{r}


res.all=NULL
eff.all=NULL
for(i in unique(df.m$Compound)){
  if(length(unique(df.m[df.m$Compound==i,]$Set))>1){    
    fit = glmer.nb(value~Group+(1|Set),data=df.m[df.m$Compound==i,])
  } else {
    fit = MASS::glm.nb(value~Group,data=df.m[df.m$Compound==i,])
  }
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts
  
  res$SGPV = sgpvalue(
  est.lo=res$asymp.LCL,
  est.hi=res$asymp.UCL,
  null.lo=log(.9),
  null.hi=log(1.1),
  inf.correction = 1e-05,
  warnings = TRUE
  )$p.delta
  
  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P")),caption="Differences in the number of pupae")
  
  
  
  res.all = rbind(res.all,data.frame(Compound = i,res[,c(1,7)]))
  
  eff.all =  rbind(eff.all,data.frame(Compound = i,res[,c(1,7)]))
    
    
}

colnames(res.all)[3] = "Pupae Count"

colnames(eff.all)[3] = "Pupae Count"


knitr::kable(res.all,digits=3,caption = "Second Generation P-values")

# res.all[res.all$Comparison == "NA - Control",]
  
```

### Results plots {.tabset}

#### Second Generation P-val Heatmap

```{r, fig.width=3.5,fig.height=12}

p_val_heatmap(format_heat(res.all))

```

#### log2(fold-change) Heatmap


```{r, fig.width=3.5,fig.height=12}

eff_heatmap(format_heat(eff.all))

```


## Activity {.tabset}

For each activity assay, the same regression method was used. Robust linear mixed-effects models with a natural log transformation.  Many of these data types would fall roughly into something like a Gamma, log-normal, or some other similar distribution from the exponential family, because they time or episodic in nature. However, I'm not convinced they all fit neatly into these models and the data are close enough to continuous that a robust regression should produce a good fit.  The natural log transformation also moves these data from an exponential family closer to Gaussian (log would be the common link function for each of these distributions). The robust version of the mixed-effects model should also help guard against any heteroscedasticity (unequal variances) or influential values.


### Time Awake {.tabset}

```{r}

library(qdapRegex)
df=NULL
all.files = list.files(pattern = ".xlsx$", recursive = TRUE)

for(i in all.files[grepl( "Activity", all.files, fixed = TRUE)|grepl( "activity", all.files, fixed = TRUE)]){
  
  df.t = read_excel(i,sheet = 3,skip=2)
  df.t$Set = case_when(grepl( "Blue", i, fixed = TRUE)~"Blue",
                       grepl( "Orange", i, fixed = TRUE)~"Orange",
                       grepl( "Pink", i, fixed = TRUE)~"Pink",
                       grepl( "blue", i, fixed = TRUE)~"Blue",
                       grepl( "orange", i, fixed = TRUE)~"Orange",
                       grepl( "pink", i, fixed = TRUE)~"Pink",
                       TRUE~"Check"
  )
  
  
  
  df.t$ID = df.t$Group
  # df.t$Group = unlist(ex_between(df.t$Group,"-","-"))
  df.t$Group = gsub('[0-9]+', '', df.t$Group)
  df.t$Group[substr(df.t$Group,1,6) == "F-Ctrl"] = "F-Ctrl"
  df.t = df.t[! df.t$`Fly Number` %in% c("Average","SEM"), ]
  df.t$Compound = sub("/.*", "", i)
  df=rbind(df,df.t)
    
}


df$Group=gsub("-hi"," H",(df$Group))
df$Group=gsub("-me"," M",(df$Group))
df$Group=gsub("-lo"," L",(df$Group))

df$Group=gsub("-Hi"," H",(df$Group))
df$Group=gsub("-Me"," M",(df$Group))
df$Group=gsub("-Lo"," L",(df$Group))

df$Group=gsub("-HI"," H",(df$Group))
df$Group=gsub("-ME"," M",(df$Group))
df$Group=gsub("-LO"," L",(df$Group))

df$Group=gsub("\\(","",(df$Group))
df$Group=gsub("\\)","",(df$Group))

df$Group=gsub("F-","",(df$Group))

df[grepl( "ctrl", tolower( df$Group), fixed = TRUE),]$Group = "Control"

# table(df$Compound)

df$Conc = gsub(".*-","" ,gsub("F-","", df$Group))
df$Subgrp = gsub("-.*","" ,gsub("F-","", df$Group))
df$Conc = tolower(df$Conc)



df.m = reshape2::melt(df,id.vars=c("Group" ,"Fly Number"   , "Bin Length", "Set"       ,   "ID","Conc","Subgrp","Compound"))
df.m$Sample = gsub("\\D", "", df.m$ID)

df.m$Group = factor(df.m$Group,levels=c("Control",unique(df.m$Group)[unique(df.m$Group) !="Control"]))

df.m$value = df.m$value = as.numeric(as.character(df.m$value))

df.m$Set.x = paste0(df.m$Set,df.m$Compound)
df.m$ID = paste0(df.m$ID,df.m$Set.x)

```

#### Exploratory

```{r, fig.height=7,fig.width=17}
knitr::kable(table(df$Compound))

ggplot(df.m,aes(x=Group,y=value,color=Group,shape=Set)) + theme_classic(12)+theme(legend.position = "none")+geom_jitter(width=0.15,height=0)+   scale_color_viridis(discrete=T)+ylab("Total time for every fly")+facet_wrap(~variable,ncol=1,scales="free_y")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())


agg.d = aggregate(value~Group+variable,df.m,"median")
# agg.d$value = exp(agg.d$`log(value)`)

ggplot(agg.d,aes(x=Group,y=value,fill=Group)) + theme_classic(12)+theme(legend.position = "none")+geom_bar(stat="identity") +   scale_fill_viridis(discrete=T)+ylab("Total time per Replicate")+facet_wrap(~variable,ncol=1,scales="free_y")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())




```


#### Analysis


```{r}

res.all=NULL
eff.all=NULL

for(i in unique(df.m$Compound)){

  # fit24 = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,])
  # fit24 = glmmTMB::glmmTMB(value~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,],family="nbinom2")
  # 
  fit24 = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fit24,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.95),
    null.hi=log(1.05),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")


  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake 24 hours")

  res.24 = res[,c(1,7)]
  colnames(res.24)[2] = "Total Awake"

  eff.24 = res[,c(1,2)]
  colnames(eff.24)[2] = "Total Awake"
  
  
  
  # fitL = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable == "1st 12-hour bin" &df.m$Compound == i,])
  fitL = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "1st 12-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fitL,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")

  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake Light")

  res.l = res[,c(1,7)]
  colnames(res.l)[2] = "Light"

  eff.l = res[,c(1,2)]
  colnames(eff.l)[2] = "Light"

  
  # fitD = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable ==  "2nd 12-hour bin" &df.m$Compound == i,])
    fitD = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "2nd 12-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fitD,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")

  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake Dark")


  res.d = res[,c(1,7)]
  colnames(res.d)[2] = "Dark"

  eff.d = res[,c(1,2)]
  colnames(eff.d)[2] = "Dark"
  
  
  res.all=rbind(res.all,merge(merge(res.24,res.l,by="Comparison"),res.d,by="Comparison"))
  
  eff.all=rbind(eff.all,merge(merge(eff.24,eff.l,by="Comparison"),eff.d,by="Comparison"))

}


knitr::kable(res.all,digits=3,caption = "Second Generation P-values")

# res.all[res.all$Comparison == "NA - Control",]
  
```

#### Results plots {.tabset}

##### Second Generation P-val Heatmap

```{r, fig.width=length(unique(df.m$variable))*1.5,fig.height=length(unique(df.m$Group))/12}

p_val_heatmap(format_heat(res.all))
```

##### log2(fold-change) Heatmap


```{r, fig.width=length(unique(df.m$variable))*1.5,fig.height=length(unique(df.m$Group))/12}

eff_heatmap(format_heat(eff.all))

```

### Activity Awake {.tabset}

```{r}

library(qdapRegex)
df=NULL
all.files = list.files(pattern = ".xlsx$", recursive = TRUE)

for(i in all.files[grepl( "Activity", all.files, fixed = TRUE)|grepl( "activity", all.files, fixed = TRUE)]){
  
  df.t = read_excel(i,sheet = 4,skip=2)
  df.t$Set = case_when(grepl( "Blue", i, fixed = TRUE)~"Blue",
                       grepl( "Orange", i, fixed = TRUE)~"Orange",
                       grepl( "Pink", i, fixed = TRUE)~"Pink",
                       grepl( "blue", i, fixed = TRUE)~"Blue",
                       grepl( "orange", i, fixed = TRUE)~"Orange",
                       grepl( "pink", i, fixed = TRUE)~"Pink",
                       TRUE~"Check"
  )
  
  
  
  df.t$ID = df.t$Group
  # df.t$Group = unlist(ex_between(df.t$Group,"-","-"))
  df.t$Group = gsub('[0-9]+', '', df.t$Group)
  df.t$Group[substr(df.t$Group,1,6) == "F-Ctrl"] = "F-Ctrl"
  df.t = df.t[! df.t$`Fly Number` %in% c("Average","SEM"), ]
  df.t$Compound = sub("/.*", "", i)
  df=rbind(df,df.t)
    
}


df$Group=gsub("-hi"," H",(df$Group))
df$Group=gsub("-me"," M",(df$Group))
df$Group=gsub("-lo"," L",(df$Group))

df$Group=gsub("-Hi"," H",(df$Group))
df$Group=gsub("-Me"," M",(df$Group))
df$Group=gsub("-Lo"," L",(df$Group))

df$Group=gsub("-HI"," H",(df$Group))
df$Group=gsub("-ME"," M",(df$Group))
df$Group=gsub("-LO"," L",(df$Group))

df$Group=gsub("\\(","",(df$Group))
df$Group=gsub("\\)","",(df$Group))

df$Group=gsub("F-","",(df$Group))

df[grepl( "ctrl", tolower( df$Group), fixed = TRUE),]$Group = "Control"

# table(df$Compound)

df$Conc = gsub(".*-","" ,gsub("F-","", df$Group))
df$Subgrp = gsub("-.*","" ,gsub("F-","", df$Group))
df$Conc = tolower(df$Conc)



df.m = reshape2::melt(df,id.vars=c("Group" ,"Fly Number"   , "Bin Length", "Set"       ,   "ID","Conc","Subgrp","Compound"))
df.m$Sample = gsub("\\D", "", df.m$ID)

df.m$Group = factor(df.m$Group,levels=c("Control",unique(df.m$Group)[unique(df.m$Group) !="Control"]))

df.m$value = df.m$value = as.numeric(as.character(df.m$value))

df.m$Set.x = paste0(df.m$Set,df.m$Compound)
df.m$ID = paste0(df.m$ID,df.m$Set.x)

```

#### Exploratory

```{r, fig.height=7,fig.width=17}

knitr::kable(table(df$Compound))

ggplot(df.m,aes(x=Group,y=value,color=Group,shape=Set)) + theme_classic(12)+theme(legend.position = "none")+geom_jitter(width=0.15,height=0)+   scale_color_viridis(discrete=T)+ylab("Total time for every fly")+facet_wrap(~variable,ncol=1,scales="free_y")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())


agg.d = aggregate(value~Group+variable,df.m,"median")
# agg.d$value = exp(agg.d$`log(value)`)

ggplot(agg.d,aes(x=Group,y=value,fill=Group)) + theme_classic(12)+theme(legend.position = "none")+geom_bar(stat="identity") +   scale_fill_viridis(discrete=T)+ylab("Total time per Replicate")+facet_wrap(~variable,ncol=1,scales="free_y")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())




```


#### Analysis


```{r}

res.all=NULL
eff.all=NULL

for(i in unique(df.m$Compound)){

  # fit24 = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,])
  # fit24 = glmmTMB::glmmTMB(value~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,],family="nbinom2")
  # 
  fit24 = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fit24,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.95),
    null.hi=log(1.05),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")


  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake 24 hours")

  res.24 = res[,c(1,7)]
  colnames(res.24)[2] = "Total Awake"

  eff.24 = res[,c(1,2)]
  colnames(eff.24)[2] = "Total Awake"
  
  
  
  # fitL = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable == "1st 12-hour bin" &df.m$Compound == i,])
  fitL = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "1st 12-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fitL,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")

  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake Light")

  res.l = res[,c(1,7)]
  colnames(res.l)[2] = "Light"

  eff.l = res[,c(1,2)]
  colnames(eff.l)[2] = "Light"

  
  # fitD = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable ==  "2nd 12-hour bin" &df.m$Compound == i,])
    fitD = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "2nd 12-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fitD,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")

  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake Dark")


  res.d = res[,c(1,7)]
  colnames(res.d)[2] = "Dark"

  eff.d = res[,c(1,2)]
  colnames(eff.d)[2] = "Dark"
  
  
  res.all=rbind(res.all,merge(merge(res.24,res.l,by="Comparison"),res.d,by="Comparison"))
  
  eff.all=rbind(eff.all,merge(merge(eff.24,eff.l,by="Comparison"),eff.d,by="Comparison"))

}


knitr::kable(res.all,digits=3,caption = "Second Generation P-values")

# res.all[res.all$Comparison == "NA - Control",]
  
```

#### Results plots {.tabset}

##### Second Generation P-val Heatmap

```{r, fig.width=length(unique(df.m$variable))*1.5,fig.height=length(unique(df.m$Group))/12}

p_val_heatmap(format_heat(res.all))
```

##### log2(fold-change) Heatmap


```{r, fig.width=length(unique(df.m$variable))*1.5,fig.height=length(unique(df.m$Group))/12}

eff_heatmap(format_heat(eff.all))

```



### Sleep Episodes {.tabset}

```{r}

library(qdapRegex)
df=NULL
all.files = list.files(pattern = ".xlsx$", recursive = TRUE)

for(i in all.files[grepl( "Activity", all.files, fixed = TRUE)|grepl( "activity", all.files, fixed = TRUE)]){
  
  df.t = read_excel(i,sheet = 5,skip=2)
  df.t$Set = case_when(grepl( "Blue", i, fixed = TRUE)~"Blue",
                       grepl( "Orange", i, fixed = TRUE)~"Orange",
                       grepl( "Pink", i, fixed = TRUE)~"Pink",
                       grepl( "blue", i, fixed = TRUE)~"Blue",
                       grepl( "orange", i, fixed = TRUE)~"Orange",
                       grepl( "pink", i, fixed = TRUE)~"Pink",
                       TRUE~"Check"
  )
  
  
  
  df.t$ID = df.t$Group
  # df.t$Group = unlist(ex_between(df.t$Group,"-","-"))
  df.t$Group = gsub('[0-9]+', '', df.t$Group)
  df.t$Group[substr(df.t$Group,1,6) == "F-Ctrl"] = "F-Ctrl"
  df.t = df.t[! df.t$`Fly Number` %in% c("Average","SEM"), ]
  df.t$Compound = sub("/.*", "", i)
  df=rbind(df,df.t)
    
}


df$Group=gsub("-hi"," H",(df$Group))
df$Group=gsub("-me"," M",(df$Group))
df$Group=gsub("-lo"," L",(df$Group))

df$Group=gsub("-Hi"," H",(df$Group))
df$Group=gsub("-Me"," M",(df$Group))
df$Group=gsub("-Lo"," L",(df$Group))

df$Group=gsub("-HI"," H",(df$Group))
df$Group=gsub("-ME"," M",(df$Group))
df$Group=gsub("-LO"," L",(df$Group))

df$Group=gsub("\\(","",(df$Group))
df$Group=gsub("\\)","",(df$Group))

df$Group=gsub("F-","",(df$Group))

df[grepl( "ctrl", tolower( df$Group), fixed = TRUE),]$Group = "Control"

# table(df$Compound)

df$Conc = gsub(".*-","" ,gsub("F-","", df$Group))
df$Subgrp = gsub("-.*","" ,gsub("F-","", df$Group))
df$Conc = tolower(df$Conc)



df.m = reshape2::melt(df,id.vars=c("Group" ,"Fly Number"   , "Bin Length", "Set"       ,   "ID","Conc","Subgrp","Compound"))
df.m$Sample = gsub("\\D", "", df.m$ID)

df.m$Group = factor(df.m$Group,levels=c("Control",unique(df.m$Group)[unique(df.m$Group) !="Control"]))

df.m$value = df.m$value = as.numeric(as.character(df.m$value))

df.m$Set.x = paste0(df.m$Set,df.m$Compound)
df.m$ID = paste0(df.m$ID,df.m$Set.x)

```

#### Exploratory

```{r, fig.height=7,fig.width=17}
knitr::kable(table(df$Compound))

ggplot(df.m,aes(x=Group,y=value,color=Group,shape=Set)) + theme_classic(12)+theme(legend.position = "none")+geom_jitter(width=0.15,height=0)+   scale_color_viridis(discrete=T)+ylab("Total time for every fly")+facet_wrap(~variable,ncol=1,scales="free_y")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())


agg.d = aggregate(value~Group+variable,df.m,"median")
# agg.d$value = exp(agg.d$`log(value)`)

ggplot(agg.d,aes(x=Group,y=value,fill=Group)) + theme_classic(12)+theme(legend.position = "none")+geom_bar(stat="identity") +   scale_fill_viridis(discrete=T)+ylab("Total time per Replicate")+facet_wrap(~variable,ncol=1,scales="free_y")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())




```


#### Analysis


```{r}

res.all=NULL
eff.all=NULL

for(i in unique(df.m$Compound)){

  # fit24 = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,])
  # fit24 = glmmTMB::glmmTMB(value~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,],family="nbinom2")
  # 
  fit24 = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fit24,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.95),
    null.hi=log(1.05),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")


  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake 24 hours")

  res.24 = res[,c(1,7)]
  colnames(res.24)[2] = "Total Awake"

  eff.24 = res[,c(1,2)]
  colnames(eff.24)[2] = "Total Awake"
  
  
  
  # fitL = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable == "1st 12-hour bin" &df.m$Compound == i,])
  fitL = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "1st 12-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fitL,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")

  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake Light")

  res.l = res[,c(1,7)]
  colnames(res.l)[2] = "Light"

  eff.l = res[,c(1,2)]
  colnames(eff.l)[2] = "Light"

  
  # fitD = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable ==  "2nd 12-hour bin" &df.m$Compound == i,])
    fitD = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "2nd 12-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fitD,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")

  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake Dark")


  res.d = res[,c(1,7)]
  colnames(res.d)[2] = "Dark"

  eff.d = res[,c(1,2)]
  colnames(eff.d)[2] = "Dark"
  
  
  res.all=rbind(res.all,merge(merge(res.24,res.l,by="Comparison"),res.d,by="Comparison"))
  
  eff.all=rbind(eff.all,merge(merge(eff.24,eff.l,by="Comparison"),eff.d,by="Comparison"))

}


knitr::kable(res.all,digits=3,caption = "Second Generation P-values")

# res.all[res.all$Comparison == "NA - Control",]
  
```

#### Results plots {.tabset}

##### Second Generation P-val Heatmap

```{r, fig.width=length(unique(df.m$variable))*1.5,fig.height=length(unique(df.m$Group))/12}

p_val_heatmap(format_heat(res.all))
```

##### log2(fold-change) Heatmap


```{r, fig.width=length(unique(df.m$variable))*1.5,fig.height=length(unique(df.m$Group))/12}

eff_heatmap(format_heat(eff.all))

```



### Total Sleep {.tabset}

```{r}

library(qdapRegex)
df=NULL
all.files = list.files(pattern = ".xlsx$", recursive = TRUE)

for(i in all.files[grepl( "Activity", all.files, fixed = TRUE)|grepl( "activity", all.files, fixed = TRUE)]){
  
  df.t = read_excel(i,sheet = 6,skip=2)
  df.t$Set = case_when(grepl( "Blue", i, fixed = TRUE)~"Blue",
                       grepl( "Orange", i, fixed = TRUE)~"Orange",
                       grepl( "Pink", i, fixed = TRUE)~"Pink",
                       grepl( "blue", i, fixed = TRUE)~"Blue",
                       grepl( "orange", i, fixed = TRUE)~"Orange",
                       grepl( "pink", i, fixed = TRUE)~"Pink",
                       TRUE~"Check"
  )
  
  
  
  df.t$ID = df.t$Group
  # df.t$Group = unlist(ex_between(df.t$Group,"-","-"))
  df.t$Group = gsub('[0-9]+', '', df.t$Group)
  df.t$Group[substr(df.t$Group,1,6) == "F-Ctrl"] = "F-Ctrl"
  df.t = df.t[! df.t$`Fly Number` %in% c("Average","SEM"), ]
  df.t$Compound = sub("/.*", "", i)
  df=rbind(df,df.t)
    
}


df$Group=gsub("-hi"," H",(df$Group))
df$Group=gsub("-me"," M",(df$Group))
df$Group=gsub("-lo"," L",(df$Group))

df$Group=gsub("-Hi"," H",(df$Group))
df$Group=gsub("-Me"," M",(df$Group))
df$Group=gsub("-Lo"," L",(df$Group))

df$Group=gsub("-HI"," H",(df$Group))
df$Group=gsub("-ME"," M",(df$Group))
df$Group=gsub("-LO"," L",(df$Group))

df$Group=gsub("\\(","",(df$Group))
df$Group=gsub("\\)","",(df$Group))

df$Group=gsub("F-","",(df$Group))

df[grepl( "ctrl", tolower( df$Group), fixed = TRUE),]$Group = "Control"

# table(df$Compound)

df$Conc = gsub(".*-","" ,gsub("F-","", df$Group))
df$Subgrp = gsub("-.*","" ,gsub("F-","", df$Group))
df$Conc = tolower(df$Conc)



df.m = reshape2::melt(df,id.vars=c("Group" ,"Fly Number"   , "Bin Length", "Set"       ,   "ID","Conc","Subgrp","Compound"))
df.m$Sample = gsub("\\D", "", df.m$ID)

df.m$Group = factor(df.m$Group,levels=c("Control",unique(df.m$Group)[unique(df.m$Group) !="Control"]))

df.m$value = df.m$value = as.numeric(as.character(df.m$value))

df.m$Set.x = paste0(df.m$Set,df.m$Compound)
df.m$ID = paste0(df.m$ID,df.m$Set.x)

```

#### Exploratory

```{r, fig.height=7,fig.width=17}
knitr::kable(table(df$Compound))

ggplot(df.m,aes(x=Group,y=value,color=Group,shape=Set)) + theme_classic(12)+theme(legend.position = "none")+geom_jitter(width=0.15,height=0)+   scale_color_viridis(discrete=T)+ylab("Total time for every fly")+facet_wrap(~variable,ncol=1,scales="free_y")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())


agg.d = aggregate(value~Group+variable,df.m,"median")
# agg.d$value = exp(agg.d$`log(value)`)

ggplot(agg.d,aes(x=Group,y=value,fill=Group)) + theme_classic(12)+theme(legend.position = "none")+geom_bar(stat="identity") +   scale_fill_viridis(discrete=T)+ylab("Total time per Replicate")+facet_wrap(~variable,ncol=1,scales="free_y")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())




```


#### Analysis


```{r}

res.all=NULL
eff.all=NULL

for(i in unique(df.m$Compound)){

  # fit24 = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,])
  # fit24 = glmmTMB::glmmTMB(value~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,],family="nbinom2")
  # 
  fit24 = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "24-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fit24,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.95),
    null.hi=log(1.05),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")


  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake 24 hours")

  res.24 = res[,c(1,7)]
  colnames(res.24)[2] = "Total Awake"

  eff.24 = res[,c(1,2)]
  colnames(eff.24)[2] = "Total Awake"
  
  
  
  # fitL = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable == "1st 12-hour bin" &df.m$Compound == i,])
  fitL = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "1st 12-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fitL,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")

  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake Light")

  res.l = res[,c(1,7)]
  colnames(res.l)[2] = "Light"

  eff.l = res[,c(1,2)]
  colnames(eff.l)[2] = "Light"

  
  # fitD = glmer.nb(value~Group+(1|Set/ID),data=df.m[df.m$variable ==  "2nd 12-hour bin" &df.m$Compound == i,])
    fitD = rlmer(log(value+1)~Group+(1|Set/ID),data=df.m[df.m$variable == "2nd 12-hour bin" &df.m$Compound == i,])

  res = confint(emmeans(fitD,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")

  res$Significant= ifelse(res$`Second Gen P` == 0, "*","")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P","Significant")),caption="Total time awake Dark")


  res.d = res[,c(1,7)]
  colnames(res.d)[2] = "Dark"

  eff.d = res[,c(1,2)]
  colnames(eff.d)[2] = "Dark"
  
  
  res.all=rbind(res.all,merge(merge(res.24,res.l,by="Comparison"),res.d,by="Comparison"))
  
  eff.all=rbind(eff.all,merge(merge(eff.24,eff.l,by="Comparison"),eff.d,by="Comparison"))

}


knitr::kable(res.all,digits=3,caption = "Second Generation P-values")

# res.all[res.all$Comparison == "NA - Control",]
  
```

#### Results plots {.tabset}

##### Second Generation P-val Heatmap

```{r, fig.width=length(unique(df.m$variable))*1.5,fig.height=length(unique(df.m$Group))/12}

p_val_heatmap(format_heat(res.all))
```

##### log2(fold-change) Heatmap


```{r, fig.width=length(unique(df.m$variable))*1.5,fig.height=length(unique(df.m$Group))/12}

eff_heatmap(format_heat(eff.all))

```


## Immune {.tabset}



```{r}
# 
library(docxtractr)

all.files = list.files(pattern = ".docx$", recursive = TRUE)
df=NULL

for(i in all.files){

  doc1 = read_docx(i)
  #Grab only the males
  df1 = as.data.frame(docx_extract_all_tbls(doc1, guess_header = TRUE, preserve = FALSE, trim = TRUE))
  if(nrow(df1 >0)){
    df1 = df1[,1:4]
    colnames(df1)[1:4] = c("Chemical","Rep1","Rep2","Rep3")
  
    df1$Set = case_when(grepl( "Blue", i, fixed = TRUE)~"Blue",
                        grepl( "Orange", i, fixed = TRUE)~"Orange",
                        grepl( "Pink", i, fixed = TRUE)~"Pink",
                        grepl( "blue", i, fixed = TRUE)~"Blue",
                        grepl( "orange", i, fixed = TRUE)~"Orange",
                        grepl( "pink", i, fixed = TRUE)~"Pink",
                           TRUE~"Check"
      )
  
    df1$Compound = sub("/.*", "", i)
    df = rbind(df,df1)
  }
}


colnames(df)[1]="Group"
df$Group = gsub(" ","",gsub("max","H",gsub("mid","M",gsub("min","L",df$Group))))
df$Group = gsub(" ","",gsub("high","H",gsub("med","M",gsub("low","L",df$Group))))

df$Group = gsub(" ","",gsub("Max","H",gsub("Mid","M",gsub("Min","L",df$Group))))
df$Group = gsub(" ","",gsub("High","H",gsub("Med","M",gsub("Low","L",df$Group))))


df$Group[df$Group == "controlna"] = "Control"

#### Needs edits
df.m = reshape2::melt(df,id.vars=c("Group","Set","Compound"))

df.m$ID = paste0(df.m$variable,df.m$Set)
df.m$Group = gsub(",","",df.m$Group)
df.m$Group = gsub("-","",df.m$Group)
df.m=na.omit(df.m)

df.m$Group = factor(df.m$Group,levels=unique(df.m$Group))

df.m$value = as.numeric(df.m$value)
```


### Exploratory

```{r, fig.height=4,fig.width=18}

ggplot(df.m,aes(x=Group,y=value,color=Group,shape=Set)) +theme_classic(14)+theme(legend.position = "none",axis.text.x = element_text(angle=45,hjust=1))+geom_jitter(height = 0,width=.15)+    scale_color_viridis(discrete=T)+ylab("Number of Flies With Black Dot")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())

agg.d = aggregate(value~Group,df.m,mean)

ggplot(agg.d,aes(x=Group,y=value,fill=Group)) +theme_classic(14)+theme(legend.position = "none",axis.text.x = element_text(angle=45,hjust=1))+geom_bar(stat="identity")+    scale_fill_viridis(discrete=T)+ylab("Number of Flies With Black Dot")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())



 
```

### Analysis {.tabset}

These data were analyzed using a cumulative probit ordinal regression.  Even though these data are count based, they are counts out of 20.  Each replicate is more akin to 20 individual Bernoulli events, but the events are not independent of each other. So this is an over dispersed binomial, or beta-binomial. Instead of fitting what is a quite complex regression, we've chosen to use a cumulative probit.  The outcome (number of flies/20 with black dots) is ordinal and bounded which fits nicely into this framework. This would be similar to analyzing these data with a Wilcoxon test, but with more power and lower false positive rate.

#### Results

```{r}

res.all=NULL
eff.all=NULL

for(i in unique(df.m$Compound)){
  if(length(unique(df.m[df.m$Compound == i,]$Set))>2){
    fit = clmm(as.factor(value)~Group+(1|Set),data=df.m[df.m$Compound == i,],link="probit")
  } else {
    fit = clm(as.factor(value)~Group,data=df.m[df.m$Compound == i,],link="probit")
  }
  
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts

  res$SGPV = sgpvalue(
  est.lo=res$asymp.LCL,
  est.hi=res$asymp.UCL,
  null.lo=log(.9),
  null.hi=log(1.1),
  inf.correction = 1e-05,
  warnings = TRUE
  )$p.delta

  # res$estimate = exp(res$estimate)


  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")

  
  res.all = rbind(res.all,data.frame(Compound = i,res[,c(1,7)]))
  
  eff.all =  rbind(eff.all,data.frame(Compound = i,res[,c(1,7)]))
    
    
}

colnames(res.all)[3] = "Number of Flies With Black Dot"

colnames(eff.all)[3] = "Number of Flies With Black Dot"


knitr::kable(res.all,digits=3,caption = "Second Generation P-values")

# res.all[res.all$Comparison == "NA - Control",]
  
```

### Results plots {.tabset}

#### Second Generation P-val Heatmap

```{r ,fig.width= 3.5 ,fig.height = 10}

p_val_heatmap(format_heat(res.all))

```

#### log2(fold-change) Heatmap


```{r ,fig.width= 3.5 ,fig.height = 10}


eff_heatmap(format_heat(eff.all))

```


## RING {.tabset}

```{r}

all.files = list.files(pattern = ".xlsx$", recursive = TRUE)

df=NULL
for(i in all.files[grepl( "ring", all.files, fixed = TRUE)|grepl( "Ring", all.files, fixed = TRUE)|grepl( "RING", all.files, fixed = TRUE)]){
  
  sht = which(tolower(excel_sheets(path = i)) =="analysis")

  
  df.t = read_excel(i,sheet = sht)
  df.t$Set = case_when(grepl( "Blue", i, fixed = TRUE)~"Blue",
                       grepl( "Orange", i, fixed = TRUE)~"Orange",
                       grepl( "Pink", i, fixed = TRUE)~"Pink",
                       grepl( "blue", i, fixed = TRUE)~"Blue",
                       grepl( "orange", i, fixed = TRUE)~"Orange",
                       grepl( "pink", i, fixed = TRUE)~"Pink",
                       TRUE~"Check"
  )
  
  df.t = df.t[,-which(is.na(df.t[1,]))]
  
  colnames(df.t)[1:2] = c("Time","Measure")
  
  df.t = as.data.frame(reshape2::melt(df.t,id.vars=c("Time","Measure","Set")))
  df.t$Compound = sub("/.*", "", i)
  df.t = df.t[!is.na(df.t$value),]
  
  df.t$Group = gsub("\\..*","",df.t$variable)
  df.t$ID = gsub(".*\\.","",df.t$variable)

  df.t =  subset(df.t,select= - c(variable))
  
  df.t$Time = na.locf(df.t$Time)
  
  df.t$ID = as.numeric(df.t$ID)
  df.t$ID[is.na(df.t$ID)] = 1
  
  df.t = df.t[df.t$Group !=0,]
  
  df=rbind(df,df.t)
    
}

df$Group[tolower(df$Group) == "control" | tolower(df$Group) == "c"|tolower(df$Group) == "ctrl"|df$Group == ""] = "Control"
df$Measure[tolower(df$Measure) == "culmulative"] = "cumulative"

df = df[!grepl( "female", tolower(df$Group), fixed = TRUE),]

df$Group = gsub("MALE","",df$Group)
df$Group = gsub("male","",df$Group)
df$Group = gsub("Male","",df$Group)
df$Group=gsub("\\(","",(df$Group))
df$Group=gsub("\\)","",(df$Group))

df$Group=gsub("-","",(df$Group))

df$Group=gsub(",","",(df$Group))

df$Group[substrRight(df$Group,1) == " "] = trimws(df$Group[substrRight(df$Group,1) == " "],which="right")

df.m=df


df.m$value = df.m$value = as.numeric(as.character(df.m$value))


df.m = df.m[!is.na(df.m$Measure),]
df.m$Group = factor(df.m$Group,levels=c("Control",unique(df.m$Group)[unique(df.m$Group) !="Control"]))

```


### Exploratory
 
Three main outcomes. 5 seconds, 15s cumulative and 30s cumulative (not all analysis tabs had a 30s timepoint, I can make this happen for all data, but it'd be considerable effort; probably better off doing it within the Excel files)

```{r, fig.height=10,fig.width=20}

knitr::kable(table(df.m$Compound))

p1=ggplot(df.m[df.m$Time == "5 second data" &df.m$Measure == "average",],aes(x=Group,y=value,color=Group,shape=Set)) + theme_classic(12)+theme(legend.position = "none")+geom_jitter(width=0.15,height=0)+   scale_color_viridis(discrete=T)+ylab("5 Second data")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())

agg.d = aggregate(value~Group,df.m[df.m$Time == "5 second data" &df.m$Measure == "average",],mean)
p1.1=ggplot(agg.d,aes(x=Group,y=value,fill=Group)) + theme_classic(12)+theme(legend.position = "none")+geom_bar(stat="identity")+   scale_fill_viridis(discrete=T)+ylab("5 Second Data")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())

p2=ggplot(df.m[df.m$Time == "15 second data" &df.m$Measure == "cumulative",],aes(x=Group,y=value,color=Group,shape=Set)) + theme_classic(12)+theme(legend.position = "none")+geom_jitter(width=0.15,height=0)+   scale_color_viridis(discrete=T)+ylab("15 Second cumulative data")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())

agg.d = aggregate(value~Group,df.m[df.m$Time == "15 second data" &df.m$Measure == "cumulative",],mean)
p2.1 = ggplot(agg.d,aes(x=Group,y=value,fill=Group)) + theme_classic(12)+theme(legend.position = "none")+geom_bar(stat="identity")+   scale_fill_viridis(discrete=T)+ylab("15 Second cumulative Data")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())


p3=ggplot(df.m[df.m$Time == "25 second data" &df.m$Measure == "cumulative",],aes(x=Group,y=value,color=Group,shape=Set)) + theme_classic(12)+theme(legend.position = "none")+geom_jitter(width=0.15,height=0)+   scale_color_viridis(discrete=T)+ylab("25 Second cumulative data")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())

agg.d = aggregate(value~Group,df.m[df.m$Time == "25 second data" &df.m$Measure == "cumulative",],mean)
p3.1 = ggplot(agg.d,aes(x=Group,y=value,fill=Group)) + theme_classic(12)+theme(legend.position = "none")+geom_bar(stat="identity")+   scale_fill_viridis(discrete=T)+ylab("25 Second cumulative Data")+theme(axis.text.x = element_text(angle=90,hjust=1),strip.background = element_blank())

p1/p2/p3

p1.1/p2.1/p3.1


```

### Analysis {.tabset}

#### Results


```{r}

res.all=NULL
eff.all=NULL


for(i in unique(df.m$Compound)){
  if(length(unique(df.m[df.m$Compound==i&df.m$Time == "5 second data" &df.m$Measure == "average",]$Set))>2){    
    fit = clmm(as.factor(value)~Group+(1|Set),data=df.m[df.m$Compound == i&df.m$Time == "5 second data" &df.m$Measure == "average",])
  } else {
    fit = clm(as.factor(value)~Group,data=df.m[df.m$Compound == i&df.m$Time == "5 second data" &df.m$Measure == "average",])
  }
  
  
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts
  
  if(any(is.na(res))){
    res$SGPV = 0.5
  } else {
  
    res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
    )$p.delta
  }
  
  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P")),caption="Differences in the number of pupae")
  
  res.5 = res[,c(1,7)]
  colnames(res.5)[2] = "5S"

  eff.5 = res[,c(1,2)]
  colnames(eff.5)[2] = "5S"
  
  
  if(length(unique(df.m[df.m$Compound==i&df.m$Time == "15 second data" &df.m$Measure == "cumulative",]$Set))>2){    
    fit = clmm(as.factor(value)~Group+(1|Set),data=df.m[df.m$Compound == i&df.m$Time == "15 second data" &df.m$Measure == "cumulative",])
  } else {
    fit = clm(as.factor(value)~Group,data=df.m[df.m$Compound == i&df.m$Time == "15 second data" &df.m$Measure == "cumulative",])
  }
  
  
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts
  
 if(any(is.na(res))){
    res$SGPV = 0.5
  } else {
  
    res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
    )$p.delta
  }
 
  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P")),caption="Differences in the number of pupae")
  
  res.15 = res[,c(1,7)]
  colnames(res.15)[2] = "15S Cumulative"

  eff.15 = res[,c(1,2)]
  colnames(eff.15)[2] = "15S Cumulative"
  
  
    
  if(length(unique(df.m[df.m$Compound==i&df.m$Time == "25 second data" &df.m$Measure == "cumulative",]$Set))>2){    
    fit = clmm(as.factor(value)~Group+(1|Set),data=df.m[df.m$Compound == i&df.m$Time == "25 second data" &df.m$Measure == "cumulative",])
  } else {
    fit = clm(as.factor(value)~Group,data=df.m[df.m$Compound == i&df.m$Time == "25 second data" &df.m$Measure == "cumulative",])
  }
  
  res = confint(emmeans(fit,trt.vs.ctrl~Group,adjust="none"))$contrasts
  
 if(any(is.na(res))){
    res$SGPV = 0.5
  } else {
  
    res$SGPV = sgpvalue(
    est.lo=res$asymp.LCL,
    est.hi=res$asymp.UCL,
    null.lo=log(.9),
    null.hi=log(1.1),
    inf.correction = 1e-05,
    warnings = TRUE
    )$p.delta
  }
 
  # res$estimate = exp(res$estimate)
  colnames(res)=c("Comparison","Fractional Difference","se","df","Low","Up","Second Gen P")
  knitr::kable(subset(res,select= c("Comparison","Fractional Difference","Second Gen P")),caption="Differences in the number of pupae")
  
  res.25 = res[,c(1,7)]
  colnames(res.25)[2] = "25S Cumulative"

  eff.25 = res[,c(1,2)]
  colnames(eff.25)[2] = "25S Cumulative"

  
  res.all=rbind(res.all,merge(merge(res.5,res.15,by="Comparison"),res.25,by="Comparison"))
  
  eff.all=rbind(eff.all,merge(merge(eff.5,eff.15,by="Comparison"),eff.25,by="Comparison"))

}

knitr::kable(res.all,digits=3,caption = "Second Generation P-values")

# res.all[res.all$Comparison == "NA - Control",]
  
```

#### Results plots {.tabset}

##### Second Generation P-val Heatmap

```{r, fig.width=5,fig.height=length(unique(df.m$Group))/12}

p_val_heatmap(format_heat(res.all))

```

##### log2(fold-change) Heatmap


```{r, fig.width=5,fig.height=length(unique(df.m$Group))/12}

eff_heatmap(format_heat(eff.all))

```



